from typing import cast

from nonebot.adapters.onebot.v11 import Message, MessageSegment
from nonebot.params import CommandArg

from util import command

_data = {
  # å­—æ¯
  'a': 'É', 'b': 'q', 'c': 'É”', 'd': 'p', 'e': 'Ç', 'f': 'ÉŸ', 'g': 'Æƒ', 'h': 'É¥', 'i': 'á´‰',
  'j': 'É¾', 'k': 'Ê', 'l': 'l', 'm': 'É¯', 'n': 'u', 'o': 'o', 'p': 'd', 'q': 'b', 'r': 'É¹',
  's': 's', 't': 'Ê‡', 'u': 'n', 'v': 'ÊŒ', 'w': 'Ê', 'x': 'x', 'y': 'Ê', 'z': 'z',
  'A': 'âˆ€', 'B': 'ğ’', 'C': 'Æ†', 'D': 'á—¡', 'E': 'Æ', 'F': 'â„²', 'G': 'â…', 'H': 'H', 'I': 'I',
  'J': 'Å¿', 'K': 'â‹Š', 'L': 'Ë¥', 'M': 'W', 'N': 'á´', 'O': 'O', 'P': 'Ô€', 'Q': 'ÎŒ', 'R': 'á´š',
  'S': '5', 'T': 'â”´', 'U': 'âˆ©', 'V': 'Î›', 'W': 'M', 'X': 'X', 'Y': 'â…„', 'Z': 'Z',
  # æ•°å­—
  '1': 'â‡‚', '2': 'â†Š', '3': 'Æ', '4': 'á”­', '5': 'S', '6': '9', '7': 'ğ˜“', '8': '8', '9': '6',
  '0': '0',
  'ï¼‘': 'â‡‚', 'ï¼’': 'â†Š', 'ï¼“': 'Æ', 'ï¼”': 'á”­', 'ï¼•': 'S', 'ï¼–': 'ï¼™', 'ï¼—': 'ğ˜“', 'ï¼˜': 'ï¼˜',
  'ï¼™': 'ï¼–', 'ï¼': 'ï¼',
  # æ‹¬å·
  '(': ')', '[': ']', '{': '}', '<': '>', 'âŒ©': 'âŒª', 'âª': 'â«', 'â¬': 'â­', 'â°': 'â±', 'â²': 'â³',
  'â´': 'âµ', 'âŸ¦': 'âŸ§', 'âŸ¨': 'âŸ©', 'âŸ®': 'âŸ¯', 'â¦ƒ': 'â¦„', 'â¦…': 'â¦†', 'â¦—': 'â¦˜', 'â§¼': 'â§½', 'â¸¨': 'â¸©',
  'â®': 'â¯', 'âŸª': 'âŸ«', 'â¦‡': 'â¦ˆ', 'â¦‰': 'â¦Š', 'âŒˆ': 'âŒ‹', 'âŒŠ': 'âŒ‰', 'ã€Œ': 'ã€', 'ã€': 'ã€',
  'ã€ˆ': 'ã€‰', 'ã€': 'ã€‘', 'ã€Š': 'ã€‹', 'ã€”': 'ã€•', 'ã€–': 'ã€—', 'ã€š': 'ã€›', 'â½': 'â‚', 'â¾': 'â‚',
  'ï¹™': 'ï¹š', 'ï¹›': 'ï¹œ', 'ï¹': 'ï¹', 'âœ': 'â', 'â': 'âŸ', 'â´': 'âµ', 'â ': 'â¡', 'ï¸µ': 'ï¸¶',
  'ï¸—': 'ï¸˜', 'ï¸·': 'ï¸¸', 'ï¸¹': 'ï¸º', 'ï¸¿': 'ï¹€', 'ï¹': 'ï¹‚', 'ï¹‡': 'ï¹ˆ', 'ï¸»': 'ï¸¼', 'ï¸½': 'ï¸¾',
  'ï¹ƒ': 'ï¹„',
  # å…¶ä»–ç‰¹æ®Šç¬¦å·
  '?': 'Â¿', '!': 'Â¡', '.': 'Ë™', ',': 'â€˜', ';': 'Ø›', '&': 'â…‹', '_': 'â€¾', '/': '\\', 'âˆ´': 'âˆµ',
}
DATA = {v: k for k, v in _data.items()}
DATA.update(_data)
del _data
DATA = {k: v for k, v in DATA.items() if k != v}


upside_down = (
  command.CommandBuilder("text_generator.upside_down", "é¢ å€’")
  .brief("ä¸Šä¸‹é¢ å€’æ–‡å­—")
  .usage('''\
/é¢ å€’ <æ–‡å­—>
ä»…æ”¯æŒè‹±æ–‡å¤§å°å†™å’Œæ•°å­—ï¼Œä¸­æ–‡åªåè½¬é¡ºåº''')
  .build()
)
@upside_down.handle()
async def handle_upside_down(arg: Message = CommandArg()):
  if not arg:
    await upside_down.finish(upside_down.__doc__)
  output = Message()
  for seg in reversed(arg):
    if seg.type == "text":
      text = "".join(DATA.get(i, i) for i in reversed(cast(str, seg.data["text"])))
      output.append(MessageSegment.text(text))
    else:
      output.append(seg)
  await upside_down.finish(output)
