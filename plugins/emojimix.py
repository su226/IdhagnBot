import os
import re

import aiohttp
from nonebot.adapters.onebot.v11 import Bot, Event, Message, MessageSegment
from nonebot.params import CommandArg
from pydantic import Field

from util import command, context, util
from util.config import BaseState


class State(BaseState):
  __file__ = "emojimix"
  unsupported: set[str] = Field(default_factory=set)


CACHE_DIR = "states/emojimix_cache"
os.makedirs(CACHE_DIR, exist_ok=True)


def write_cache(cache: str, data: bytes):
  with open(cache, "wb") as f:
    f.write(data)


STATE = State.load()
API = "https://www.gstatic.com/android/keyboard/emojikitchen"
EMOJIS: list[tuple[str, str]] = [
  ('â˜ï¸', '20201001'),
  ('â˜•', '20201001'),
  ('â˜¹ï¸', '20201001'),
  ('â˜ºï¸', '20201001'),
  ('â™¥ï¸', '20201001'),
  ('âš½', '20220406'),
  ('â›„', '20201001'),
  ('â£ï¸', '20201001'),
  ('â¤ï¸', '20201001'),
  ('â¤ï¸\u200dğŸ©¹', '20210218'),
  ('â­', '20201001'),
  ('ğŸŒ‡', '20210831'),
  ('ğŸŒˆ', '20201001'),
  ('ğŸŒ', '20201001'),
  ('ğŸŒ›', '20201001'),
  ('ğŸŒœ', '20201001'),
  ('ğŸŒ', '20201001'),
  ('ğŸŒŸ', '20201001'),
  ('ğŸŒªï¸', '20201001'),
  ('ğŸŒ­', '20201001'),
  ('ğŸŒ²', '20201001'),
  ('ğŸŒµ', '20201001'),
  ('ğŸŒ¶ï¸', '20201001'),
  ('ğŸŒ·', '20201001'),
  ('ğŸŒ¸', '20210218'),
  ('ğŸŒ¹', '20201001'),
  ('ğŸŒ¼', '20201001'),
  ('ğŸ„', '20220406'),
  ('ğŸ‰', '20220406'),
  ('ğŸŠ', '20211115'),
  ('ğŸ‹', '20210521'),
  ('ğŸŒ', '20211115'),
  ('ğŸ', '20201001'),
  ('ğŸ’', '20220406'),
  ('ğŸ“', '20210831'),
  ('ğŸ', '20210831'),
  ('ğŸ½ï¸', '20201001'),
  ('ğŸ', '20211115'),
  ('ğŸ‚', '20201001'),
  ('ğŸƒ', '20201001'),
  ('ğŸˆ', '20201001'),
  ('ğŸŠ', '20201001'),
  ('ğŸ—ï¸', '20201001'),
  ('ğŸ§', '20210521'),
  ('ğŸ…', '20220203'),
  ('ğŸ†', '20211115'),
  ('ğŸŒ', '20210218'),
  ('ğŸ', '20210831'),
  ('ğŸ™', '20201001'),
  ('ğŸ', '20201001'),
  ('ğŸŸ', '20210831'),
  ('ğŸ¢', '20201001'),
  ('ğŸ¦', '20210831'),
  ('ğŸ§', '20211115'),
  ('ğŸ¨', '20201001'),
  ('ğŸ©', '20211115'),
  ('ğŸ­', '20201001'),
  ('ğŸ¯', '20220110'),
  ('ğŸ°', '20201001'),
  ('ğŸ±', '20201001'),
  ('ğŸµ', '20201001'),
  ('ğŸ¶', '20211115'),
  ('ğŸ·', '20201001'),
  ('ğŸ»', '20210831'),
  ('ğŸ¼', '20201001'),
  ('ğŸ‘€', '20201001'),
  ('ğŸ‘ï¸', '20201001'),
  ('ğŸ‘‘', '20201001'),
  ('ğŸ‘»', '20201001'),
  ('ğŸ‘½', '20201001'),
  ('ğŸ‘¿', '20201001'),
  ('ğŸ’€', '20201001'),
  ('ğŸ’‹', '20201001'),
  ('ğŸ’Œ', '20201001'),
  ('ğŸ’', '20201001'),
  ('ğŸ’', '20201001'),
  ('ğŸ’“', '20201001'),
  ('ğŸ’”', '20201001'),
  ('ğŸ’•', '20201001'),
  ('ğŸ’–', '20201001'),
  ('ğŸ’—', '20201001'),
  ('ğŸ’˜', '20201001'),
  ('ğŸ’™', '20201001'),
  ('ğŸ’š', '20201001'),
  ('ğŸ’›', '20201001'),
  ('ğŸ’œ', '20201001'),
  ('ğŸ’', '20201001'),
  ('ğŸ’', '20201001'),
  ('ğŸ’Ÿ', '20201001'),
  ('ğŸ’¥', '20220203'),
  ('ğŸ’©', '20201001'),
  ('ğŸ’«', '20201001'),
  ('ğŸ’¬', '20220203'),
  ('ğŸ’¯', '20201001'),
  ('ğŸ“°', '20201001'),
  ('ğŸ”¥', '20201001'),
  ('ğŸ”®', '20201001'),
  ('ğŸ•³ï¸', '20201001'),
  ('ğŸ•·ï¸', '20201001'),
  ('ğŸ–¤', '20201001'),
  ('ğŸ˜€', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜‚', '20201001'),
  ('ğŸ˜ƒ', '20201001'),
  ('ğŸ˜„', '20201001'),
  ('ğŸ˜…', '20201001'),
  ('ğŸ˜†', '20201001'),
  ('ğŸ˜‡', '20201001'),
  ('ğŸ˜ˆ', '20201001'),
  ('ğŸ˜‰', '20201001'),
  ('ğŸ˜Š', '20201001'),
  ('ğŸ˜‹', '20201001'),
  ('ğŸ˜Œ', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜‘', '20201001'),
  ('ğŸ˜’', '20201001'),
  ('ğŸ˜“', '20201001'),
  ('ğŸ˜”', '20201001'),
  ('ğŸ˜•', '20201001'),
  ('ğŸ˜–', '20201001'),
  ('ğŸ˜—', '20201001'),
  ('ğŸ˜˜', '20201001'),
  ('ğŸ˜™', '20201001'),
  ('ğŸ˜š', '20201001'),
  ('ğŸ˜›', '20201001'),
  ('ğŸ˜œ', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜', '20201001'),
  ('ğŸ˜Ÿ', '20201001'),
  ('ğŸ˜ ', '20201001'),
  ('ğŸ˜¡', '20201001'),
  ('ğŸ˜¢', '20201001'),
  ('ğŸ˜£', '20201001'),
  ('ğŸ˜¤', '20201001'),
  ('ğŸ˜¥', '20201001'),
  ('ğŸ˜¦', '20201001'),
  ('ğŸ˜§', '20201001'),
  ('ğŸ˜¨', '20201001'),
  ('ğŸ˜©', '20201001'),
  ('ğŸ˜ª', '20201001'),
  ('ğŸ˜«', '20201001'),
  ('ğŸ˜¬', '20201001'),
  ('ğŸ˜­', '20201001'),
  ('ğŸ˜®', '20201001'),
  ('ğŸ˜®\u200dğŸ’¨', '20210218'),
  ('ğŸ˜¯', '20201001'),
  ('ğŸ˜°', '20201001'),
  ('ğŸ˜±', '20201001'),
  ('ğŸ˜²', '20201001'),
  ('ğŸ˜³', '20201001'),
  ('ğŸ˜´', '20201001'),
  ('ğŸ˜µ', '20201001'),
  ('ğŸ˜¶', '20201001'),
  ('ğŸ˜¶\u200dğŸŒ«ï¸', '20210218'),
  ('ğŸ˜·', '20201001'),
  ('ğŸ™', '20201001'),
  ('ğŸ™‚', '20201001'),
  ('ğŸ™ƒ', '20201001'),
  ('ğŸ™„', '20201001'),
  ('ğŸ™ˆ', '20201001'),
  ('ğŸ¤', '20201001'),
  ('ğŸ¤', '20201001'),
  ('ğŸ¤', '20201001'),
  ('ğŸ¤‘', '20201001'),
  ('ğŸ¤’', '20201001'),
  ('ğŸ¤“', '20201001'),
  ('ğŸ¤”', '20201001'),
  ('ğŸ¤•', '20201001'),
  ('ğŸ¤–', '20201001'),
  ('ğŸ¤—', '20201001'),
  ('ğŸ¤ ', '20201001'),
  ('ğŸ¤¡', '20201001'),
  ('ğŸ¤¢', '20201001'),
  ('ğŸ¤£', '20201001'),
  ('ğŸ¤¤', '20201001'),
  ('ğŸ¤¥', '20201001'),
  ('ğŸ¤§', '20201001'),
  ('ğŸ¤¨', '20201001'),
  ('ğŸ¤©', '20201001'),
  ('ğŸ¤ª', '20201001'),
  ('ğŸ¤«', '20201001'),
  ('ğŸ¤¬', '20201001'),
  ('ğŸ¤­', '20201001'),
  ('ğŸ¤®', '20201001'),
  ('ğŸ¤¯', '20201001'),
  ('ğŸ¥‡', '20220203'),
  ('ğŸ¥ˆ', '20220203'),
  ('ğŸ¥‰', '20220203'),
  ('ğŸ¥‘', '20201001'),
  ('ğŸ¥°', '20201001'),
  ('ğŸ¥±', '20201001'),
  ('ğŸ¥²', '20201001'),
  ('ğŸ¥³', '20201001'),
  ('ğŸ¥´', '20201001'),
  ('ğŸ¥µ', '20201001'),
  ('ğŸ¥¶', '20201001'),
  ('ğŸ¥¸', '20201001'),
  ('\U0001f979', '20211115'),
  ('ğŸ¥º', '20201001'),
  ('ğŸ¦', '20201001'),
  ('ğŸ¦‚', '20210218'),
  ('ğŸ¦„', '20210831'),
  ('ğŸ¦‡', '20201001'),
  ('ğŸ¦‰', '20210831'),
  ('ğŸ¦Œ', '20201001'),
  ('ğŸ¦”', '20201001'),
  ('ğŸ¦™', '20201001'),
  ('ğŸ¦', '20211115'),
  ('ğŸ¦ ', '20201001'),
  ('ğŸ¦¥', '20201001'),
  ('ğŸ¦´', '20220203'),
  ('ğŸ¦·', '20220203'),
  ('ğŸ§€', '20201001'),
  ('ğŸ§', '20201001'),
  ('ğŸ§', '20201001'),
  ('ğŸ§ ', '20220203'),
  ('ğŸ§¡', '20201001'),
  ('ğŸª„', '20210521'),
  ('ğŸª¨', '20220406'),
  ('ğŸªµ', '20211115'),
  ('ğŸ«€', '20220203'),
  ('ğŸ«', '20220203'),
  ('\U0001fae0', '20211115'),
  ('\U0001fae1', '20211115'),
  ('\U0001fae2', '20211115'),
  ('\U0001fae3', '20211115'),
  ('\U0001fae4', '20211115'),
  ('\U0001fae5', '20211115'),
  ('\U0001fae6', '20220203'),
]
IGNORE_RE = re.compile(r"[+\s\u200b\ufe0f\U0001f3fb-\U0001f3ff\U0001F9B0-\U0001F9B3]")


def get_code(emoji: str) -> str:
  return "_".join(map(lambda ch: "u{:x}".format(ord(ch)), emoji))


def split_emojis(argv: str) -> tuple[tuple[str, str], tuple[str, str]]:
  argv = IGNORE_RE.sub("", argv)
  first_match: None | tuple[str, str] = None
  for char, date in EMOJIS:
    if argv.startswith(IGNORE_RE.sub("", char)):
      first_match = char, date
      break
  else:
    raise KeyError("No match")
  argv = argv.removeprefix(first_match[0])
  for char, date in EMOJIS:
    if argv == IGNORE_RE.sub("", char):
      return first_match, (char, date)
  else:
    raise KeyError("No match")


emojimix = (
  command.CommandBuilder("emojimix", "emojimix", "ç¼åˆ", "emoji", "mix")
  .brief("ç¼åˆä¸¤ä¸ªemoji")
  .usage('''\
/emojimix - æŸ¥çœ‹æ”¯æŒçš„emoji
/emojimix <emoji1>+<emoji2> - ç¼åˆä¸¤ä¸ªemoji
æ•°æ®æ¥è‡ª https://tikolu.net/emojimix
å›¾ç‰‡æ¥è‡ª Google''')
  .build())


@emojimix.handle()
async def handle_emojimix(bot: Bot, event: Event, args: Message = CommandArg()):
  argv = args.extract_plain_text().rstrip()
  if not argv:
    self_name = await context.get_card_or_name(bot, event, event.self_id)
    nodes = [util.forward_node(event.self_id, self_name, "æ”¯æŒçš„ emojiï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰ç»„åˆéƒ½å­˜åœ¨ï¼‰ï¼š")]
    for i in util.groupbyn(EMOJIS, 50):
      content = " | ".join(x[0] for x in i)
      nodes.append(util.forward_node(event.self_id, self_name, content))
    await util.send_forward_msg(bot, event, *nodes)
    await emojimix.finish()
  try:
    (emoji1, date1), (emoji2, date2) = split_emojis(argv)
  except KeyError:
    await emojimix.finish("ä¼¼ä¹ä¸èƒ½è¿™ä¹ˆç»„åˆ")
  code1 = get_code(emoji1)
  code2 = get_code(emoji2)
  file1 = f"{code1}_{code2}"
  file2 = f"{code2}_{code1}"
  cache1 = os.path.abspath(f"{CACHE_DIR}/{file1}.png")
  cache2 = os.path.abspath(f"{CACHE_DIR}/{file2}.png")
  if os.path.exists(cache1):
    await emojimix.finish(MessageSegment.image("file://" + cache1))
  if os.path.exists(cache2):
    await emojimix.finish(MessageSegment.image("file://" + cache2))
  if file1 in STATE.unsupported or file2 in STATE.unsupported:
    await emojimix.finish("ä¼¼ä¹ä¸èƒ½è¿™ä¹ˆç»„åˆ")
  async with aiohttp.ClientSession() as http:
    try:
      response = await http.get(f"{API}/{date1}/{code1}/{file1}.png")
      if response.status == 200:
        image = await response.read()
        write_cache(cache1, image)
        await emojimix.finish(MessageSegment.image(image))
      response = await http.get(f"{API}/{date2}/{code2}/{file2}.png")
      if response.status == 200:
        image = await response.read()
        write_cache(cache2, image)
        await emojimix.finish(MessageSegment.image(image))
      STATE.unsupported.add(file1)
      STATE.dump()
      await emojimix.finish("ä¼¼ä¹ä¸èƒ½è¿™ä¹ˆç»„åˆ")
    except aiohttp.ClientError:
      await emojimix.finish("ç½‘ç»œé”™è¯¯")
